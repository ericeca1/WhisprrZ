{header}
{search}

<!-- Add stylesheet links with updated paths to Edge folder -->
<link rel="stylesheet" href="{url_main}_frameworks/main/whisprrz_Edge/css/looking_glass.css">
<link rel="stylesheet" href="{url_main}_frameworks/main/whisprrz_Edge/css/modals.css">
<link rel="stylesheet" href="{url_main}_frameworks/main/whisprrz_Edge/css/calendar.css">
<link rel="stylesheet" href="{url_main}_frameworks/main/whisprrz_Edge/css/gear_modal.css">

<!-- Load gallery.js -->
<script src="{url_main}_frameworks/main/whisprrz_Edge/js/gallery.js{cache_version_param}"></script>

<!-- Fix modal styling directly in the page -->
<style>
#gearModal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    overflow: auto;
}

#gearModal .modal-content {
    background: white;
    width: 400px;
    padding: 20px;
    margin: 10% auto;
    border-radius: 10px;
    text-align: center;
    position: relative;
    max-width: 90%;
}

#gearModal .close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    cursor: pointer;
    font-size: 20px;
}

#gearModal .save-btn {
    background-color: #007bff;
    color: white;
    padding: 10px;
    border: none;
    cursor: pointer;
    border-radius: 5px;
    margin-top: 10px;
    width: 100%;
}

.pref-section {
    margin-bottom: 15px;
    text-align: left;
}

#gearModal select {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
}

#gearModal .checkbox-group, 
#gearModal .radio-group {
    text-align: left;
    margin-top: 5px;
}

#gearModal label {
    display: block;
    margin-bottom: 5px;
    cursor: pointer;
}
</style>

<!-- Prevent header from showing in middle of page with proper structure -->
<div class="looking-glass-wrapper" id="looking-glass-main-container">
    <!-- begin_looking_glass_group -->
    <div class="looking-glass-container">
        <div class="looking-glass-header">
            <h5 class="sub-group-title">
                LookinGlass
            </h5>

            <div class="tabbable-panel">
                <div class="tabbable-line">
                    <ul class="nav nav-tabs">
                        <li>
                            <a href="javascript:void(0);" onclick="showSearchModal(); return false;" data-toggle="modal" data-target="#lookingGlassSearchModal">Search</a>
                        </li>
                        <li class="friends-tab">
                            <a href="{url_page_photos_list}?offset=friends" onclick="loadTab('friends', '{url_page_photos_list}?offset=friends'); return false;">Friends</a>
                        </li>
                        <li class="online-tab">
                            <a href="{url_page_photos_list}?offset=online" onclick="loadTab('online', '{url_page_photos_list}?offset=online'); return false;">Online</a>
                        </li>
                        <li class="matches-tab">
                            <a href="{url_page_photos_list}?offset=matches" onclick="loadTab('matches', '{url_page_photos_list}?offset=matches'); return false;">Matches</a>
                        </li>
                        <li class="nearby-tab">
                            <a href="{url_page_photos_list}?offset=nearby" onclick="loadTab('nearby', '{url_page_photos_list}?offset=nearby'); return false;">User Near</a>
                        </li>
                     </ul>
                </div>
            </div>

            <div class="feed_head_txt">
                <!-- Fixed: Use only one handler for the gear icon -->
                <a class="icon_setting_gear" href="javascript:void(0);" onclick="openGearModal(); return false;"></a>
            </div>
        </div>

        <div class="clearfix"></div>
        <div><hr></div>

        <div class="blogs_wrap page_list {page_class}">
            <div class="list-container">
                <div class="module_filter_result">
                    <!-- Photos content block -->
                    <div class="content-section photos-section">
                        <div class="section-header">
                            <h4>Photos</h4>
                            <div class="section-tabs">
                                <ul class="nav nav-pills photo-tabs">
                                    <li class="photos-filter-all active"><a href="#" onclick="filterPhotos('all'); return false;">All Photos</a></li>
                                    <li class="photos-filter-recent"><a href="#" onclick="filterPhotos('recent'); return false;">Recent Uploads</a></li>
                                    <li class="photos-filter-popular"><a href="#" onclick="filterPhotos('popular'); return false;">Most Viewed</a></li>
                                    <li class="photos-filter-featured"><a href="#" onclick="filterPhotos('featured'); return false;">Featured</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="section-subtitle">
                            <p>Browse and discover member photos from around the community</p>
                        </div>
                        <div class="row filter_result gallery-container photos-container">
                            <!-- begin_photo_items -->
                            {photo_item}
                            <!-- end_photo_items -->
                        </div>
                    </div>
                    
                    <div class="section-divider"></div>
                    
                    <!-- Videos content block -->
                    <div class="content-section videos-section">
                        <div class="section-header">
                            <h4>Video Collection</h4>
                            <div class="section-tabs">
                                <ul class="nav nav-pills video-tabs">
                                    <li class="videos-filter-all active"><a href="#" onclick="filterVideos('all'); return false;">All Videos</a></li>
                                    <li class="videos-filter-recent"><a href="#" onclick="filterVideos('recent'); return false;">Latest</a></li>
                                    <li class="videos-filter-trending"><a href="#" onclick="filterVideos('trending'); return false;">Trending</a></li>
                                    <li class="videos-filter-popular"><a href="#" onclick="filterVideos('popular'); return false;">Popular</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="section-subtitle">
                            <p>Watch videos shared by members in the community</p>
                        </div>
                        <div class="row filter_result gallery-container videos-container">
                            <!-- begin_video_items -->
                            {video_item}
                            <!-- end_video_items -->
                        </div>
                    </div>
                    
                    <div class="section-divider"></div>
                    
                    <!-- Live videos content block -->
                    <div class="content-section live-videos-section">
                        <div class="section-header">
                            <h4>Live Broadcasts</h4>
                            <div class="section-tabs">
                                <ul class="nav nav-pills live-tabs">
                                    <li class="live-filter-trending active"><a href="#" onclick="filterLiveStreams('trending'); return false;">Hot Now</a></li>
                                    <li class="live-filter-new"><a href="#" onclick="filterLiveStreams('new'); return false;">Just Started</a></li>
                                    <li class="live-filter-followed"><a href="#" onclick="filterLiveStreams('followed'); return false;">Friends Live</a></li>
                                    <li class="live-filter-go-live"><a href="#" onclick="goLive(); return false;" class="go-live-btn">Go Live</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="section-subtitle">
                            <p>Join live broadcasts from your favorite community members</p>
                        </div>
                        <div class="row filter_result gallery-container live-container">
                            <!-- begin_live_video_items -->
                            {live_video_item}
                            <!-- end_live_video_items -->
                        </div>
                    </div>
                    
                    <div class="section-divider"></div>
                    
                    <!-- Partyhouz content block -->
                    <div class="content-section partyhouz-section">
                        <div class="section-header">
                            <h4>Partyhouz Events</h4>
                            <div class="section-tabs">
                                <ul class="nav nav-pills partyhouz-tabs">
                                    <li class="partyhouz-filter-upcoming active"><a href="#" onclick="filterPartyhouz('upcoming'); return false;">Live</a></li>
                                    <li class="partyhouz-filter-trending"><a href="#" onclick="filterPartyhouz('trending'); return false;">Trending</a></li>
                                    <li class="partyhouz-filter-my"><a href="#" onclick="filterPartyhouz('my'); return false;">Past Live</a></li>
                                    <li class="partyhouz-filter-create"><a href="#" onclick="createPartyEvent(); return false;" class="create-event-btn">Create Event</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="section-subtitle">
                            <p>Discover and join exciting events in your community</p>
                        </div>
                        <div class="row filter_result gallery-container partyhouz-container">
                            <!-- begin_partyhouz_items -->
                            {partyhouz_item}
                            <!-- end_partyhouz_items -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- end_looking_glass_group -->
</div>

<!-- Completely updated Gear Modal -->
<div id="gearModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeGearModal()">&times;</span>
        <h2>User Preferences</h2>

        <!-- Default Content Selection -->
        <div class="pref-section">
            <label for="defaultContent">Default View:</label>
            <select id="defaultContent" class="pref-select">
                <option value="photos">Photos</option>
                <option value="videos">Videos</option>
                <option value="live">Live Streams</option>
                <option value="partyhouz">Partyhouz Events</option>
            </select>
        </div>

        <!-- Sorting Preference -->
        <div class="pref-section">
            <p>Sort content by default using:</p>
            <div class="radio-group">
                <label><input type="radio" name="sort" value="latest" checked> Latest</label>
                <label><input type="radio" name="sort" value="trending"> Trending</label>
                <label><input type="radio" name="sort" value="popular"> Most Viewed</label>
            </div>
        </div>

        <!-- Content Filters -->
        <div class="pref-section">
            <p>Content Display:</p>
            <div class="checkbox-group">
                <label><input type="checkbox" id="showPhotos" checked> Show Photos</label>
                <label><input type="checkbox" id="showVideos" checked> Show Videos</label>
                <label><input type="checkbox" id="showLiveStreams" checked> Show Live Streams</label>
                <label><input type="checkbox" id="showPartyhouz" checked> Show Partyhouz Events</label>
            </div>
        </div>

        <!-- Notification Settings -->
        <div class="pref-section">
            <p>Notifications:</p>
            <div class="checkbox-group">
                <label><input type="checkbox" id="notifyLiveStreams" checked> Notify when friends go live</label>
                <label><input type="checkbox" id="notifyPartyhouz"> Notify about upcoming events</label>
            </div>
        </div>

        <!-- Display Options -->
        <div class="pref-section">
            <label for="itemsPerPage">Items per page:</label>
            <select id="itemsPerPage" class="pref-select">
                <option value="12">12 items</option>
                <option value="24" selected>24 items</option>
                <option value="48">48 items</option>
            </select>
            <div class="checkbox-group"></div>
                <label><input type="checkbox" id="autoplayVideos"> Autoplay videos when browsing</label>
                <label><input type="checkbox" id="muteVideos" checked> Mute videos by default</label>
            </div>
        </div>

        <!-- Save Button -->
        <button class="save-btn" onclick="saveUserPreferences()">Save Preferences</button>
    </div>
</div>

<!-- User Preferences Modal -->
<div id="userPreferencesModal" class="user-prefs-modal">
    <div class="user-prefs-modal-content">
        <div class="user-prefs-modal-header">
            <h2>User Preferences</h2>
            <span class="user-prefs-close-btn" onclick="closeUserPreferencesModal()">&times;</span>
        </div>
        <div class="user-prefs-modal-body">
            <!-- Default Content Selection -->
            <div class="pref-section">
                <h3>Default View</h3>
                <div class="pref-option">
                    <label for="defaultContent">When I open Looking Glass, show me:</label>
                    <select id="defaultContent" class="pref-select">
                        <option value="photos">Photos</option>
                        <option value="videos">Videos</option>
                        <option value="live">Live Streams</option>
                        <option value="partyhouz">Partyhouz Events</option>
                    </select>
                </div>
            </div>

            <!-- Sorting Preference -->
            <div class="pref-section">
                <h3>Content Sorting</h3>
                <div class="pref-option">
                    <p>Sort content by default using:</p>
                    <div class="radio-group">
                        <label><input type="radio" name="sort" value="latest" checked> Latest</label>
                        <label><input type="radio" name="sort" value="trending"> Trending</label>
                        <label><input type="radio" name="sort" value="popular"> Most Viewed</label>
                    </div>
                </div>
            </div>

            <!-- Content Filters -->
            <div class="pref-section">
                <h3>Content Display</h3>
                <div class="pref-option checkbox-group">
                    <label><input type="checkbox" id="showPhotos" checked> Show Photos</label>
                    <label><input type="checkbox" id="showVideos" checked> Show Videos</label>
                    <label><input type="checkbox" id="showLiveStreams" checked> Show Live Streams</label>
                    <label><input type="checkbox" id="showPartyhouz" checked> Show Partyhouz Events</label>
                </div>
            </div>

            <!-- Notification Settings -->
            <div class="pref-section">
                <h3>Notifications</h3>
                <div class="pref-option checkbox-group"></div>
                    <label><input type="checkbox" id="notifyLiveStreams" checked> Notify when friends go live</label>
                    <label><input type="checkbox" id="notifyPartyhouz"> Notify about upcoming events</label>
                </div>
            </div>

            <!-- Display Options -->
            <div class="pref-section">
                <h3>Display Options</h3>
                <div class="pref-option">
                    <label for="itemsPerPage">Items per page:</label>
                    <select id="itemsPerPage" class="pref-select">
                        <option value="12">12 items</option>
                        <option value="24" selected>24 items</option>
                        <option value="48">48 items</option>
                    </select>
                </div>
                <div class="pref-option checkbox-group">
                    <label><input type="checkbox" id="autoplayVideos"> Autoplay videos when browsing</label>
                    <label><input type="checkbox" id="muteVideos" checked> Mute videos by default</label>
                </div>
            </div>
        </div>
        <div class="user-prefs-modal-footer">
            <button class="user-prefs-cancel-btn" onclick="closeUserPreferencesModal()">Cancel</button>
            <button class="user-prefs-save-btn" onclick="saveUserPreferences()">Save Preferences</button>
        </div>
    </div>
</div>

<!-- Modals section - Fix z-index and accessibility -->
<div id="looking-glass-modals" style="z-index: 9999;">
    <!-- Gear Modal -->
    <div id="gearModal" class="modal fade" style="z-index: 10000;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeGearModal()">&times;</span>
            <h2>User Preferences</h2>

            <!-- Default Content Selection -->
            <div class="pref-section">
                <label for="defaultContent">Default View:</label>
                <select id="defaultContent" class="pref-select">
                    <option value="photos">Photos</option>
                    <option value="videos">Videos</option>
                    <option value="live">Live Streams</option>
                    <option value="partyhouz">Partyhouz Events</option>
                </select>
            </div>

            <!-- Sorting Preference -->
            <div class="pref-section">
                <p>Sort content by default using:</p>
                <div class="radio-group">
                    <label><input type="radio" name="sort" value="latest" checked> Latest</label><br>
                    <label><input type="radio" name="sort" value="trending"> Trending</label><br>
                    <label><input type="radio" name="sort" value="popular"> Most Viewed</label>
                </div>
            </div>

            <!-- Content Filters -->
            <div class="pref-section">
                <p>Content Display:</p>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="showPhotos" checked> Show Photos</label><br>
                    <label><input type="checkbox" id="showVideos" checked> Show Videos</label><br>
                    <label><input type="checkbox" id="showLiveStreams" checked> Show Live Streams</label><br>
                    <label><input type="checkbox" id="showPartyhouz" checked> Show Partyhouz Events</label>
                </div>
            </div>

            <!-- Notification Settings -->
            <div class="pref-section">
                <p>Notifications:</p>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="notifyLiveStreams" checked> Notify when friends go live</label><br>
                    <label><input type="checkbox" id="notifyPartyhouz"> Notify about upcoming events</label>
                </div>
            </div>

            <!-- Display Options -->
            <div class="pref-section">
                <label for="itemsPerPage">Items per page:</label>
                <select id="itemsPerPage" class="pref-select">
                    <option value="12">12 items</option>
                    <option value="24" selected>24 items</option>
                    <option value="48">48 items</option>
                </select>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="autoplayVideos"> Autoplay videos when browsing</label><br>
                    <label><input type="checkbox" id="muteVideos" checked> Mute videos by default</label>
                </div>
            </div>

            <!-- Save Button -->
            <button class="save-btn" onclick="saveUserPreferences()">Save Preferences</button>
        </div>
    </div>

    <!-- Completely restructured search modal with proper centering -->
    <div id="lookingGlassSearchModal" class="modal fade search-modal-centered" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Search LookingGlass</h4>
                </div>
                <div class="modal-body">
                    <form id="lookingGlassSearchForm" action="" method="get">
                        <div class="form-group">
                            <label for="searchKeyword">Keyword or Name:</label>
                            <input type="text" class="form-control" id="searchKeyword" name="keyword" placeholder="Enter keyword, name or username">
                        </div>
                        
                        <div class="form-group">
                            <label>Content Type:</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="contentType[]" value="photos" checked> Photos</label>
                                <label><input type="checkbox" name="contentType[]" value="videos" checked> Videos</label>
                                <label><input type="checkbox" name="contentType[]" value="live" checked> Live Streams</label>
                                <label><input type="checkbox" name="contentType[]" value="events" checked> Events</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="searchDate">Date Range:</label>
                            <select class="form-control" id="searchDate" name="dateRange">
                                <option value="any">Any time</option>
                                <option value="today">Today</option>
                                <option value="week">This week</option>
                                <option value="month">This month</option>
                                <option value="year">This year</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Search In:</label>
                            <div class="radio-group">
                                <label><input type="radio" name="searchScope" value="all" checked> All content</label>
                                <label><input type="radio" name="searchScope" value="friends"> Friends only</label>
                                <label><input type="radio" name="searchScope" value="following"> Following only</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="searchSortBy">Sort By:</label>
                            <select class="form-control" id="searchSortBy" name="sortBy">
                                <option value="recent">Most recent</option>
                                <option value="popular">Most popular</option>
                                <option value="relevant">Most relevant</option>
                            </select>
                        </div>
                        
                        <div class="advanced-options" style="margin-top: 15px;">
                            <p><a href="#" data-toggle="collapse" data-target="#advancedSearchOptions">Advanced Options <i class="fa fa-chevron-down"></i></a></p>
                            
                            <div id="advancedSearchOptions" class="collapse">
                                <div class="form-group">
                                    <label for="searchLocation">Location:</label>
                                    <input type="text" class="form-control" id="searchLocation" name="location" placeholder="City, state or country">
                                </div>
                                
                                <div class="form-group">
                                    <label for="searchTags">Tags:</label>
                                    <input type="text" class="form-control" id="searchTags" name="tags" placeholder="Enter tags separated by commas">
                                </div>
                                
                                <div class="form-group">
                                    <label>Content Rating:</label>
                                    <div class="checkbox-group">
                                        <label><input type="checkbox" name="contentRating[]" value="g" checked> G (General)</label>
                                        <label><input type="checkbox" name="contentRating[]" value="pg" checked> PG (Parental Guidance)</label>
                                        <label><input type="checkbox" name="contentRating[]" value="mature" checked> Mature</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitLookingGlassSearch()">Search</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add a failsafe script to make sure click events work -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add a small delay to ensure all elements are loaded
    setTimeout(function() {
        // Try to fix events if the main function failed
        if (typeof fixClickEvents === 'function') {
            fixClickEvents();
        }
        
        // Direct event listeners for modals
        document.querySelector('.icon_setting_gear').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('gearModal').style.display = 'block';
            return false;
        });
        
        var searchLinks = document.querySelectorAll('a[data-target="#lookingGlassSearchModal"]');
        for (var i = 0; i < searchLinks.length; i++) {
            searchLinks[i].addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('lookingGlassSearchModal').style.display = 'block';
                return false;
            });
        }
        
        // Close buttons for modals
        var closeButtons = document.querySelectorAll('#closeGearModalBtn, #closeGearModalBtn2, #lookingGlassModalClose, #lookingGlassModalClose2');
        for (var i = 0; i < closeButtons.length; i++) {
            closeButtons[i].addEventListener('click', function(e) {
                e.preventDefault();
                
                // Check which modal to close
                if (this.id === 'closeGearModalBtn' || this.id === 'closeGearModalBtn2') {
                    document.getElementById('gearModal').style.display = 'none';
                } else {
                    document.getElementById('lookingGlassSearchModal').style.display = 'none';
                }
                
                return false;
            });
        }
    }, 1500);
});
</script>

<!-- Add this script to ensure modal uniqueness -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Ensure only one gear modal exists
    const gearModals = document.querySelectorAll('#gearModal');
    if (gearModals.length > 1) {
        for (let i = 1; i < gearModals.length; i++) {
            gearModals[i].parentNode.removeChild(gearModals[i]);
        }
    }
    
    // Make sure we have only one click handler on gear icon
    const gearIcons = document.querySelectorAll('.icon_setting_gear');
    gearIcons.forEach(function(icon) {
        const newIcon = icon.cloneNode(true);
        icon.parentNode.replaceChild(newIcon, icon);
        newIcon.addEventListener('click', function(e) {
            e.preventDefault();
            openGearModal();
            return false;
        });
    });
    
    console.log("Gear modal and handlers fixed");
    
    // Initialize search functionality
    window.submitLookingGlassSearch = function() {
        const form = document.getElementById('lookingGlassSearchForm');
        const formData = new FormData(form);
        
        // Get the search parameters
        const keyword = formData.get('keyword');
        const contentTypes = formData.getAll('contentType[]');
        const dateRange = formData.get('dateRange');
        const searchScope = formData.get('searchScope');
        const sortBy = formData.get('sortBy');
        
        // Build the search query
        let queryParams = new URLSearchParams();
        if (keyword) queryParams.append('keyword', keyword);
        if (contentTypes.length) contentTypes.forEach(type => queryParams.append('type', type));
        if (dateRange) queryParams.append('date', dateRange);
        if (searchScope) queryParams.append('scope', searchScope);
        if (sortBy) queryParams.append('sort', sortBy);
        
        // Add advanced options if they exist
        const location = formData.get('location');
        const tags = formData.get('tags');
        const contentRatings = formData.getAll('contentRating[]');
        
        if (location) queryParams.append('location', location);
        if (tags) queryParams.append('tags', tags);
        if (contentRatings.length) contentRatings.forEach(rating => queryParams.append('rating', rating));
        
        // Execute the search
        console.log("Search params:", Object.fromEntries(queryParams.entries()));
        
        // Close the modal
        $('#lookingGlassSearchModal').modal('hide');
        
        // Perform the search
        executeSearch(queryParams.toString());
    };
    
    function executeSearch(queryString) {
        // Display loading indicator
        const container = document.querySelector('.module_filter_result');
        if (container) {
            container.innerHTML = '<div class="loading-indicator"><i class="fa fa-spinner fa-spin"></i> Searching...</div>';
        }
        
        // Fetch search results
        const url = `{url_page_photos_list}?search=1&${queryString}`;
        
        // Use AJAX to load search results
        $.ajax({
            url: url,
            method: 'GET',
            success: function(response) {
                // Update the container with search results
                if (container) {
                    container.innerHTML = response;
                }
                
                // Update the URL to reflect the search
                history.pushState({}, "Search Results", url);
            },
            error: function() {
                if (container) {
                    container.innerHTML = '<div class="error-message">Search failed. Please try again.</div>';
                }
            }
        });
    }
});

// Show search modal
function showSearchModal() {
    $('#lookingGlassSearchModal').modal('show');
}

// Direct JavaScript fix for modal positioning
document.addEventListener('DOMContentLoaded', function() {
    // Override Bootstrap's modal positioning
    $.fn.modal.Constructor.prototype.enforceFocus = function() {};
    
    // Fix show search modal function
    window.showSearchModal = function() {
        var modal = $('#lookingGlassSearchModal');
        
        // Reset any styles that might have been added
        modal.find('.modal-dialog').css({
            'position': 'relative',
            'width': '500px',
            'max-width': '90%',
            'margin': '10% auto',
            'left': '0',
            'transform': 'none'
        });
        
        // Show the modal with fixed positioning
        modal.modal({
            show: true,
            backdrop: true
        });
        
        // Ensure modal is positioned correctly after shown
        modal.on('shown.bs.modal', function() {
            $(this).find('.modal-dialog').css({
                'position': 'relative',
                'width': '500px',
                'max-width': '90%',
                'margin': '10% auto',
                'left': '0',
                'transform': 'none'
            });
            
            // Make sure backdrop covers the entire screen
            $('.modal-backdrop').css({
                'width': '100%',
                'height': '100%'
            });
        });
    };
    
    console.log("Modal positioning fixed");
});
</script>

<script>
// Add this to your existing JavaScript
function openGearModal() {
    $("#gearModal").fadeIn(300);
    loadUserPreferences();
}

function closeGearModal() {
    $("#gearModal").fadeOut(300);
}

function loadUserPreferences() {
    // Load preferences from localStorage
    if (localStorage.getItem("defaultContent")) {
        document.getElementById("defaultContent").value = localStorage.getItem("defaultContent");
    }

    if (localStorage.getItem("sortPreference")) {
        let sortValue = localStorage.getItem("sortPreference");
        document.querySelector(`input[name="sort"][value="${sortValue}"]`).checked = true;
    }

    if (localStorage.getItem("showPhotos") === "false") {
        document.getElementById("showPhotos").checked = false;
    }
    
    if (localStorage.getItem("showVideos") === "false") {
        document.getElementById("showVideos").checked = false;
    }
    
    if (localStorage.getItem("showLiveStreams") === "false") {
        document.getElementById("showLiveStreams").checked = false;
    }
    
    if (localStorage.getItem("showPartyhouz") === "false") {
        document.getElementById("showPartyhouz").checked = false;
    }
    
    if (localStorage.getItem("notifyLiveStreams") === "false") {
        document.getElementById("notifyLiveStreams").checked = false;
    }
    
    if (localStorage.getItem("notifyPartyhouz") === "true") {
        document.getElementById("notifyPartyhouz").checked = true;
    }
    
    if (localStorage.getItem("itemsPerPage")) {
        document.getElementById("itemsPerPage").value = localStorage.getItem("itemsPerPage");
    }
    
    if (localStorage.getItem("autoplayVideos") === "true") {
        document.getElementById("autoplayVideos").checked = true;
    }
    
    if (localStorage.getItem("muteVideos") === "false") {
        document.getElementById("muteVideos").checked = false;
    }
}

function saveUserPreferences() {
    let defaultContent = document.getElementById("defaultContent").value;
    let sortPreference = document.querySelector('input[name="sort"]:checked').value;
    let showPhotos = document.getElementById("showPhotos").checked;
    let showVideos = document.getElementById("showVideos").checked;
    let showLiveStreams = document.getElementById("showLiveStreams").checked;
    let showPartyhouz = document.getElementById("showPartyhouz").checked;
    let notifyLiveStreams = document.getElementById("notifyLiveStreams").checked;
    let notifyPartyhouz = document.getElementById("notifyPartyhouz").checked;
    let itemsPerPage = document.getElementById("itemsPerPage").value;
    let autoplayVideos = document.getElementById("autoplayVideos").checked;
    let muteVideos = document.getElementById("muteVideos").checked;

    // Store in Local Storage
    localStorage.setItem("defaultContent", defaultContent);
    localStorage.setItem("sortPreference", sortPreference);
    localStorage.setItem("showPhotos", showPhotos);
    localStorage.setItem("showVideos", showVideos);
    localStorage.setItem("showLiveStreams", showLiveStreams);
    localStorage.setItem("showPartyhouz", showPartyhouz);
    localStorage.setItem("notifyLiveStreams", notifyLiveStreams);
    localStorage.setItem("notifyPartyhouz", notifyPartyhouz);
    localStorage.setItem("itemsPerPage", itemsPerPage);
    localStorage.setItem("autoplayVideos", autoplayVideos);
    localStorage.setItem("muteVideos", muteVideos);

    // Apply settings
    applyUserPreferences();
    
    // Close modal
    closeGearModal();
    
    // Optional: Show a confirmation
    showNotification("Preferences saved successfully!");
}

function applyUserPreferences() {
    // Apply content filters
    const showPhotos = localStorage.getItem("showPhotos") !== "false";
    const showVideos = localStorage.getItem("showVideos") !== "false";
    const showLiveStreams = localStorage.getItem("showLiveStreams") !== "false";
    const showPartyhouz = localStorage.getItem("showPartyhouz") !== "false";
    
    // Apply display settings
    if (showPhotos) {
        $(".photo-item").show();
    } else {
        $(".photo-item").hide();
    }
    
    if (showVideos) {
        $(".video-item").show();
    } else {
        $(".video-item").hide();
    }
    
    if (showLiveStreams) {
        $(".live-stream-item").show();
    } else {
        $(".live-stream-item").hide();
    }
    
    if (showPartyhouz) {
        $(".partyhouz-item").show();
    } else {
        $(".partyhouz-item").hide();
    }
    
    // Apply autoplay settings
    const autoplayVideos = localStorage.getItem("autoplayVideos") === "true";
    const muteVideos = localStorage.getItem("muteVideos") !== "false";
    
    $("video").each(function() {
        if (autoplayVideos) {
            $(this).attr("autoplay", true);
        } else {
            $(this).removeAttr("autoplay");
        }
        
        if (muteVideos) {
            $(this).attr("muted", true);
        } else {
            $(this).removeAttr("muted");
        }
    });
}

function showNotification(message) {
    // Create notification element if it doesn't exist
    if (!$("#notification-popup").length) {
        $("body").append('<div id="notification-popup" style="display:none; position:fixed; bottom:20px; right:20px; background-color:#4CAF50; color:white; padding:15px; border-radius:5px; z-index:10001;"></div>');
    }
    
    // Set message and show notification
    $("#notification-popup").text(message).fadeIn(300).delay(3000).fadeOut(300);
}

// Apply settings on page load
$(document).ready(function() {
    applyUserPreferences();
    
    // Close modal when clicking outside
    $(window).click(function(event) {
        if ($(event.target).is("#gearModal")) {
            closeGearModal();
        }
    });
});
</script>

{footer}